# 批量上传 JSON 数据到发现页

## 方法一：使用云函数批量上传（推荐）

### 1. 上传云函数

在微信开发者工具中：
1. 右键点击 `cloudfunctions/batchPublishRecords` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 选择对应的环境（开发/生产）

### 2. 在小程序中调用

创建一个测试页面或使用控制台调用：

```javascript
// 在小程序页面中调用
const fs = require('fs') // 注意：小程序中不能直接读取文件

// 方法：将 JSON 文件内容复制到代码中
const beansData = require('../../prd/beans_full.json')

// 调用云函数
wx.cloud.callFunction({
  name: 'batchPublishRecords',
  data: {
    records: beansData,
    batchSize: 50 // 每批处理50条，可根据需要调整
  },
  success: (res) => {
    console.log('批量上传结果:', res.result)
    wx.showModal({
      title: '上传完成',
      content: `成功: ${res.result.successCount} 条\n失败: ${res.result.failCount} 条`,
      showCancel: false
    })
  },
  fail: (err) => {
    console.error('批量上传失败:', err)
    wx.showToast({
      title: '上传失败',
      icon: 'none'
    })
  }
})
```

## 方法二：使用 Node.js 脚本（本地测试）

创建一个 Node.js 脚本来批量上传：

```javascript
// scripts/batchUpload.js
const cloud = require('wx-server-sdk')
const fs = require('fs')
const path = require('path')

// 初始化云开发（需要配置环境ID）
cloud.init({
  env: 'your-env-id' // 替换为你的环境ID
})

async function batchUpload() {
  try {
    // 读取 JSON 文件
    const jsonPath = path.join(__dirname, '../prd/beans_full.json')
    const jsonData = fs.readFileSync(jsonPath, 'utf8')
    const records = JSON.parse(jsonData)

    console.log(`准备上传 ${records.length} 条记录`)

    // 调用云函数
    const result = await cloud.callFunction({
      name: 'batchPublishRecords',
      data: {
        records: records,
        batchSize: 50
      }
    })

    console.log('上传结果:', result.result)
  } catch (error) {
    console.error('上传失败:', error)
  }
}

batchUpload()
```

## 方法三：直接在云开发控制台执行

1. 打开微信开发者工具
2. 进入 **"云开发"** → **"云函数"**
3. 找到 `batchPublishRecords` 函数
4. 点击 **"测试"**
5. 在测试参数中输入：

```json
{
  "records": [
    {
      "beanId": "excel_1",
      "userName": "第8个矮人(小红书)",
      "beanName": "野草莓",
      "brand": "治光师",
      "origin": "埃塞",
      "flavorNotes": ["草莓酱", "甜橙"],
      "rating": 4,
      "createTime": "2023-05-06T00:00:00"
    }
  ],
  "batchSize": 50
}
```

## 注意事项

1. **数据量限制**：建议每批处理 50-100 条记录，避免超时
2. **评分格式**：支持数字和字符串格式（如 "4-", "4.5"）
3. **时间格式**：支持 ISO 字符串和 MongoDB 日期格式
4. **类型处理**：如果 type 为空，默认设置为 "Pour Over"
5. **userId**：批量导入的记录使用固定 userId "batch_import"

## 数据格式要求

JSON 文件中的每条记录应包含以下字段：

```json
{
  "beanId": "唯一ID",
  "userName": "用户名",
  "userAvatar": "头像URL（可选）",
  "beanName": "豆名",
  "brand": "品牌",
  "type": "pourOver 或 espresso（可选）",
  "roastLevel": "烘焙度（可选）",
  "origin": "产地",
  "altitude": "海拔（可选）",
  "processMethod": "处理法（可选）",
  "roastDate": "烘焙日期（可选）",
  "flavorNotes": ["风味1", "风味2"],
  "rating": 4.0,
  "createTime": "2023-05-06T00:00:00",
  "publishTime": { "$date": "2023-05-06T00:00:00" }
}
```

