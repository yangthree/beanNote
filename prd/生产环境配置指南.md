# 🚀 生产环境配置指南

## 📋 切换步骤

### 1. 在微信开发者工具中创建/选择生产环境

1. 打开微信开发者工具
2. 点击顶部菜单栏 **"云开发"** → **"环境设置"**
3. 查看当前环境列表：
   - 如果已有生产环境，记录环境 ID（格式：`prod-xxxxx`）
   - 如果没有，点击 **"创建新环境"**，命名为 `生产环境` 或 `production`

### 2. 获取生产环境 ID

在云开发控制台的环境设置中，复制生产环境的 **环境 ID**（例如：`prod-3g3ho1oo318ec768`）

### 3. 修改环境配置

**方式一：使用环境配置文件（推荐）**

1. 打开 `utils/env.js` 文件
2. 修改 `current` 为 `'prod'`：
   ```javascript
   const ENV_CONFIG = {
     current: 'prod', // 改为 'prod' 切换到生产环境
     envIds: {
       dev: 'test-3g3ho1oo318ec768',
       prod: 'prod-3g3ho1oo318ec768' // 替换为你的生产环境 ID
     }
   }
   ```

**方式二：直接修改 app.js（不推荐）**

如果不想使用配置文件，可以直接修改 `app.js`：

```javascript
wx.cloud.init({
  env: 'prod-3g3ho1oo318ec768', // 替换为你的生产环境 ID
  traceUser: true
})
```

### 4. 上传云函数到生产环境

在微信开发者工具中：

1. 右键点击 `cloudfunctions` 文件夹下的每个云函数文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 在弹出的环境选择中，选择 **生产环境**
4. 需要上传的云函数：
   - `publishRecord`
   - `getDiscoverList`
   - `login`

### 5. 配置云数据库

在生产环境的云开发控制台中：

1. 进入 **"数据库"** → **"集合管理"**
2. 创建以下集合（如果不存在）：
   - `publish_records` - 用于存储发布的豆单记录
   - `users` - 用于存储用户信息（如果使用）
3. 设置集合权限：
   - `publish_records`: 设置为 **"仅创建者可读写"** 或根据需求设置
   - `users`: 设置为 **"仅创建者可读写"**

### 6. 配置云存储（如果需要）

如果使用了云存储上传图片：

1. 进入 **"存储"** → **"权限设置"**
2. 根据需要配置上传和下载权限

### 7. 测试生产环境

1. 在微信开发者工具中，切换到生产环境
2. 测试核心功能：
   - ✅ 登录功能
   - ✅ 发布豆单
   - ✅ 查看发现页
   - ✅ 数据存储和读取

### 8. 提交代码审核

1. 在微信开发者工具中点击 **"上传"**
2. 填写版本号和项目备注
3. 上传成功后，在微信公众平台提交审核

## ⚠️ 注意事项

### 数据迁移（如果需要）

如果测试环境有重要数据需要迁移到生产环境：

1. 在云开发控制台的测试环境中导出数据
2. 在生产环境中导入数据
3. 或者使用云函数批量迁移数据

### 环境隔离

- ✅ 测试环境和生产环境完全隔离
- ✅ 生产环境的数据不会影响测试环境
- ✅ 建议保留测试环境用于开发调试

### 安全建议

1. **不要在生产环境进行测试**
   - 生产环境只用于正式发布
   - 所有测试在测试环境完成

2. **备份重要数据**
   - 定期备份生产环境数据
   - 重要操作前先备份

3. **权限控制**
   - 严格控制数据库和存储的读写权限
   - 避免公开所有数据

## 🔍 验证清单

上线前请确认：

- [ ] `utils/env.js` 中的 `current` 已设置为 `'prod'`
- [ ] `utils/env.js` 中的生产环境 ID 已更新为实际值
- [ ] 所有云函数已上传到生产环境
- [ ] 数据库集合已创建并配置权限
- [ ] 存储权限已配置（如需要）
- [ ] 核心功能已测试通过
- [ ] 代码已上传并提交审核
- [ ] 控制台日志显示 "当前环境: 生产环境"

## 📞 常见问题

### Q: 如何同时保留测试和生产环境？

A: 使用 `utils/env.js` 配置文件，只需修改 `current` 字段即可切换：

```javascript
// 开发时
current: 'dev'

// 上线时
current: 'prod'
```

这样可以在两个环境之间快速切换，无需修改多处代码。

### Q: 云函数上传失败怎么办？

A: 
1. 检查云函数代码是否有语法错误
2. 检查 `package.json` 依赖是否正确
3. 查看云开发控制台的错误日志
4. 尝试删除后重新上传

### Q: 如何查看当前使用的环境？

A: 在云开发控制台的 **"环境设置"** 中可以看到当前激活的环境。

