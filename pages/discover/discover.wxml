<!-- pages/discover/discover.wxml -->
<!-- å‘ç°é¡µï¼šå±•ç¤ºæ‰€æœ‰ç”¨æˆ·å‘å¸ƒçš„å’–å•¡è±†è®°å½• -->
<view class="page">

  <!-- æœç´¢è¾“å…¥æ¡† -->
  <view class="search-container">
    <text class="search-icon">ğŸ”</text>
    <input
      class="search-input"
      placeholder="æœç´¢è±†åã€å“ç‰Œ..."
      placeholder-style="color:#888888"
      value="{{searchKeyword}}"
      bindinput="onSearchInput"
    />
  </view>

  <!-- ç­›é€‰æ§ä»¶ï¼ˆSegmented Controlï¼‰ -->
  <view class="filter-container">
    <view 
      class="filter-item {{filterType === 'all' ? 'active' : ''}}"
      data-type="all"
      bindtap="onFilterTypeChange"
    >
      å…¨éƒ¨
    </view>
    <view 
      class="filter-item {{filterType === 'pourOver' ? 'active' : ''}}"
      data-type="pourOver"
      bindtap="onFilterTypeChange"
    >
      æ‰‹å†²
    </view>
    <view 
      class="filter-item {{filterType === 'espresso' ? 'active' : ''}}"
      data-type="espresso"
      bindtap="onFilterTypeChange"
    >
      æ„å¼
    </view>
  </view>

  <!-- è¯„åˆ†ç­›é€‰ -->
  <view class="rating-filter-container">
    <scroll-view class="rating-filter-scroll" scroll-x="{{true}}" show-scrollbar="{{false}}">
      <view class="rating-filter-options">
        <view
          class="rating-filter-item {{ratingFilter === option.key ? 'active' : ''}}"
          wx:for="{{ratingOptions}}"
          wx:for-item="option"
          wx:key="key"
          data-key="{{option.key}}"
          bindtap="onRatingFilterChange"
        >
          {{option.label}}
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <view class="empty-state" wx:if="{{discoverList.length === 0 && !loading}}">
    <text class="empty-text">è¿˜æ²¡æœ‰äººå‘å¸ƒè±†å•ï¼Œæ¥æˆä¸ºç¬¬ä¸€ä¸ªå§ â˜•ï¸</text>
  </view>

  <!-- å‘ç°åˆ—è¡¨ -->
  <scroll-view 
    class="discover-list" 
    scroll-y="{{true}}"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onRefresh"
    bindscrolltolower="onLoadMore"
    enhanced="{{true}}"
    bounces="{{false}}"
    show-scrollbar="{{false}}"
    wx:else
  >
    <view class="bean-list">
      <view class="bean-card" wx:for="{{discoverList}}" wx:key="beanId" wx:for-item="item" wx:for-index="index" bindtap="viewDetail" data-bean="{{item}}" data-record-id="{{item._id}}">
        <!-- å›¾ç‰‡å°é¢ï¼šæ˜¾ç¤ºè±†è¢‹å›¾ç‰‡æˆ–å ä½ -->
        <view class="bean-image-wrapper">
          <view class="bean-image-placeholder">â˜•</view>
          <view class="bean-badge">{{item.type === 'pourOver' ? 'æ‰‹å†²' : 'æ„å¼'}}/{{item.roastLevel}}</view>
          <view class="bean-price-badge" wx:if="{{item.displayPrice}}">
            {{item.displayPrice}}
          </view>
        </view>

        <!-- å†…å®¹åŒº -->
        <view class="bean-content">
          <!-- ç¬¬ä¸€è¡Œï¼šè±†å + å“ç‰Œ -->
          <view class="bean-title-row">
            <text class="bean-name">{{item.beanName || 'æœªå‘½åå’–å•¡è±†'}}</text>
            <text class="bean-brand" wx:if="{{item.brand}}">{{item.brand}}</text>
          </view>

          <!-- ç¬¬äºŒè¡Œï¼šäº§åœ° + è¯„åˆ† -->
          <view class="bean-info-row">
            <text class="bean-origin" wx:if="{{item.origin}}">{{item.origin}}</text>
            <view class="bean-rating">
              <text class="star active">â˜…</text>
              <text class="rating-value">{{item.displayRating}}</text>
            </view>
          </view>
          <!-- ç¬¬ä¸‰è¡Œï¼šå¤„ç†æ³• + å³ä¾§é¢„ç•™ -->
          <view class="bean-info-row">
            <text class="bean-process" wx:if="{{item.processMethod}}">{{item.processMethod}}</text>
            <view class="bean-extra-placeholder"></view>
          </view>
        </view>

        <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆåº•éƒ¨ï¼‰ -->
        <view class="user-info-header">
          <image class="user-avatar" src="{{item.userAvatar}}" mode="aspectFill" lazy-load="{{true}}"></image>
          <view class="user-info-text">
            <text class="user-name">{{item.userName}}</text>
            <text class="publish-time">{{item.publishTime}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="load-more" wx:if="{{hasMore && !loading}}">
      <text>åŠ è½½æ›´å¤š...</text>
    </view>
    <view class="load-more" wx:if="{{!hasMore && discoverList.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </scroll-view>

  <!-- åŠ è½½ä¸­æç¤º -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ç™»å½•æç¤ºå¼¹çª—ï¼šæé†’ç”¨æˆ·æˆæƒå¾®ä¿¡ä¿¡æ¯ -->
  <view class="login-mask" wx:if="{{showLoginDialog}}">
    <view class="login-dialog" catchtap="stopPropagation">
      <view class="login-title">è¯·å…ˆç™»å½•</view>
      <view class="login-desc">
        ä¸ºä¿éšœæ•°æ®åŒæ­¥ä¸å‘å¸ƒåŠŸèƒ½ï¼Œè¯·è®¾ç½®æ‚¨çš„å¤´åƒå’Œæ˜µç§°ã€‚
      </view>
      
      <!-- ç”¨æˆ·ä¿¡æ¯è®¾ç½®åŒºåŸŸ -->
      <view class="user-info-form">
        <!-- å¤´åƒé€‰æ‹© -->
        <view class="avatar-section">
          <text class="form-label">å¤´åƒ</text>
          <button class="avatar-btn" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
            <view class="avatar-preview-wrapper">
              <image wx:if="{{tempAvatarUrl}}" class="avatar-preview" src="{{tempAvatarUrl}}" mode="aspectFill"></image>
              <view wx:else class="avatar-placeholder">
                <text class="avatar-icon">ğŸ‘¤</text>
              </view>
            </view>
            <text class="avatar-text">ç‚¹å‡»é€‰æ‹©å¤´åƒ</text>
          </button>
        </view>
        
        <!-- æ˜µç§°è¾“å…¥ -->
        <view class="nickname-section">
          <text class="form-label">æ˜µç§°</text>
          <input 
            class="nickname-input" 
            type="nickname" 
            placeholder="è¯·è¾“å…¥æ˜µç§°"
            value="{{tempNickName}}"
            bindinput="onNickNameInput"
            bindblur="onNickNameBlur"
          />
        </view>
      </view>
      
      <view class="login-actions">
        <button class="login-btn primary" hover-class="none" loading="{{isLoggingIn}}" bindtap="confirmLogin">ç¡®è®¤ç™»å½•</button>
      </view>
    </view>
  </view>
</view>

