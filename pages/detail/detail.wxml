<!-- pages/detail/detail.wxml -->
<view class="page">
  <!-- 顶部操作栏：提供返回 / 保存 / 发布 -->
  <!-- <view class="top-bar">
    <view class="back-area" bindtap="handleBack">
      <text class="back-icon">‹</text>
      <text class="back-text">返回</text>
    </view>
    <view class="top-actions">
      <button class="action-btn ghost" hover-class="none" bindtap="saveRecord">保存</button>
      <button class="action-btn primary" hover-class="none" loading="{{isPublishing}}" bindtap="publishRecord">发布</button>
    </view>
  </view> -->

  <!-- 类型切换 Tab（新增 & 编辑均保留） -->
  <view class="type-tabs">
    <view
      class="tab-item {{beanType === 'pourOver' ? 'active' : ''}}"
      data-type="pourOver"
      bindtap="selectType"
    >手冲豆</view>
    <view
      class="tab-item {{beanType === 'espresso' ? 'active' : ''}}"
      data-type="espresso"
      bindtap="selectType"
    >意式豆</view>
  </view>

  <!-- 右上角发布按钮（新建和编辑都显示） -->
  <view class="publish-btn" bindtap="openPublishDialog">
    <text class="publish-icon">☁</text>
  </view>

  <!-- 测试用：清除登录状态按钮（开发阶段使用，上线前删除） -->
  <view class="clear-login-btn" bindtap="clearLogin" wx:if="{{userProfile}}">
    <text class="clear-login-text">清除登录</text>
  </view>

  <!-- 内容区域滚动 -->
  <scroll-view class="scroll-area" scroll-y show-scrollbar="false" enhanced="true" bounces="false">
    <!-- 基本信息 -->
    <view class="section-card">
      <view class="section-title">基本信息</view>
      <view class="form-grid">
        <view class="form-item">
          <text class="form-label">咖啡豆名称 *</text>
          <input class="form-input"
            placeholder="如：Kenya AA"
            value="{{name}}"
            bindinput="onNameInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">品牌 *</text>
          <input class="form-input"
            placeholder="如：Manner"
            value="{{brand}}"
            bindinput="onBrandInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">评分 (0-5) *</text>
          <input class="form-input"
            type="digit"
            placeholder="如：4.5"
            value="{{ratingText}}"
            bindinput="onManualRatingInput"
            bindblur="onManualRatingBlur"
          />
        </view>
        <view class="form-item picker-item">
          <text class="form-label">烘焙度 *</text>
          <picker mode="selector"
            range="{{roastLevels}}"
            value="{{roastLevelIndex}}"
            bindchange="onRoastLevelChange">
            <view class="form-input picker-display">
              {{roastLevel || '选择烘焙度'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">产地</text>
          <input class="form-input"
            placeholder="如：埃塞俄比亚"
            value="{{origin}}"
            bindinput="onOriginInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">海拔 (m)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              placeholder="如：1900"
              value="{{altitude}}"
              bindinput="onAltitudeInput"
            />
            <text class="unit">m</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">处理法</text>
          <input class="form-input"
            placeholder="如：水洗 / 日晒"
            value="{{processMethod}}"
            bindinput="onProcessMethodInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">烘焙日期</text>
          <picker mode="date"
            value="{{roastDate}}"
            start="2010-01-01"
            end="2099-12-31"
            bindchange="onRoastDateChange">
            <view class="form-input picker-display">
              {{roastDate || '选择日期'}}
            </view>
          </picker>
        </view>
      </view>
    </view>

    <!-- 手冲表单 -->
    <view class="section-card" wx:if="{{beanType === 'pourOver'}}">
      <view class="section-title">手冲专属冲煮参数</view>
      <view class="form-grid">
        <view class="form-item">
          <text class="form-label">粉量 (g)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{pourOverParams.coffeeWeight}}"
              bindinput="onPourOverCoffeeWeightInput"
            />
            <text class="unit">g</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">液体量 (g)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{pourOverParams.waterWeight}}"
              bindinput="onPourOverWaterWeightInput"
            />
            <text class="unit">g</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">水温 (°C)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{pourOverParams.temperature}}"
              bindinput="onPourOverTemperatureInput"
            />
            <text class="unit">°C</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">萃取时间 (s)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{pourOverParams.time}}"
              bindinput="onPourOverTimeInput"
            />
            <text class="unit">s</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">{{beanType === 'pourOver' ? '滤杯 / 壶具' : '咖啡机'}}</text>
          <input class="form-input"
            placeholder="{{beanType === 'pourOver' ? '如：V60 / Kalita' : '如：La Marzocco'}}"
            value="{{equipmentBrewer}}"
            bindinput="onEquipmentBrewerInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">磨豆机 / 研磨度</text>
          <input class="form-input"
            placeholder="如：C40 / 25"
            value="{{pourOverParams.grindSize}}"
            bindinput="onPourOverGrindSizeInput"
          />
        </view>
        <view class="ratio-card">
          <text class="ratio-label">萃取比例</text>
          <text class="ratio-value">1 : {{pourOverRatio || '--'}}</text>
        </view>
      </view>

      <view class="score-card">
        <text class="form-label">风味评分</text>
        <view class="score-group">
          <view class="score-item">
            <text class="score-label">香气</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.aroma >= item ? 'active' : ''}}"
                data-key="aroma"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
          <view class="score-item">
            <text class="score-label">酸质</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.acidity >= item ? 'active' : ''}}"
                data-key="acidity"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
          <view class="score-item">
            <text class="score-label">甜感</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.sweetness >= item ? 'active' : ''}}"
                data-key="sweetness"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
          <view class="score-item">
            <text class="score-label">平衡感</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.balance >= item ? 'active' : ''}}"
                data-key="balance"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 意式表单 -->
    <view class="section-card" wx:if="{{beanType === 'espresso'}}">
      <view class="section-title">意式专属萃取参数</view>
      <view class="form-grid">
        <view class="form-item">
          <text class="form-label">粉量 (g)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{espressoParams.coffeeWeight}}"
              bindinput="onEspressoCoffeeWeightInput"
            />
            <text class="unit">g</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">液体量 (g)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{espressoParams.outputWeight}}"
              bindinput="onEspressoOutputWeightInput"
            />
            <text class="unit">g</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">水温 (°C)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{espressoParams.temperature}}"
              bindinput="onEspressoTemperatureInput"
            />
            <text class="unit">°C</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">萃取时间 (s)</text>
          <view class="input-with-unit">
            <input class="form-input"
              type="digit"
              value="{{espressoParams.time}}"
              bindinput="onEspressoTimeInput"
            />
            <text class="unit">s</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">{{beanType === 'pourOver' ? '滤杯 / 壶具' : '咖啡机'}}</text>
          <input class="form-input"
            placeholder="{{beanType === 'pourOver' ? '如：V60 / Kalita' : '如：La Marzocco'}}"
            value="{{equipmentBrewer}}"
            bindinput="onEquipmentBrewerInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">磨豆机 / 研磨度</text>
          <input class="form-input"
            placeholder="如：C40 / 25"
            value="{{espressoParams.grindSize}}"
            bindinput="onEspressoGrindSizeInput"
          />
        </view>
        <view class="ratio-card">
          <text class="ratio-label">萃取比例</text>
          <text class="ratio-value">1 : {{espressoRatio || '--'}}</text>
        </view>
      </view>

      <view class="score-card">
        <text class="form-label">风味评分</text>
        <view class="score-group">
          <view class="score-item">
            <text class="score-label">香气</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.aroma >= item ? 'active' : ''}}"
                data-key="aroma"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
          <view class="score-item">
            <text class="score-label">醇厚度</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.body >= item ? 'active' : ''}}"
                data-key="body"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
          <view class="score-item">
            <text class="score-label">甜感</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.sweetness >= item ? 'active' : ''}}"
                data-key="sweetness"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
          <view class="score-item">
            <text class="score-label">平衡感</text>
            <view class="score-stars">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this"
                class="star {{flavorScores.balance >= item ? 'active' : ''}}"
                data-key="balance"
                data-value="{{item}}"
                bindtap="setFlavorScore"
              >★</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 风味标签（共用） -->
    <view class="section-card">
      <view class="section-title">风味标签</view>
      <view class="form-grid flavors-block">
        <view class="form-item full">
          <view class="flavor-tags">
            <view class="tag" wx:for="{{flavors}}" wx:key="*this" data-flavor="{{item}}" catchtap="removeFlavor">
              {{item}}
              <text class="tag-remove">×</text>
            </view>
          </view>
          <input class="form-input"
            placeholder="输入后回车添加标签"
            value="{{flavorInput}}"
            bindinput="onFlavorInput"
            bindconfirm="addFlavor"
          />
        </view>
      </view>
    </view>

    <!-- 备注 -->
    <view class="section-card">
      <view class="section-title">备注</view>
      <textarea class="textarea"
        placeholder="记录口感评价、风味描述、冲煮建议等…"
        value="{{notes}}"
        bindinput="onNotesInput"
        maxlength="500"
      />
    </view>
  </scroll-view>

  <!-- 登录提示弹窗：提醒用户授权微信信息 -->
  <view class="login-mask" wx:if="{{showLoginDialog}}">
    <view class="login-dialog">
      <view class="login-title">请先登录</view>
      <view class="login-desc">
        为保障数据同步与发布功能，请设置您的头像和昵称。
      </view>
      
      <!-- 用户信息设置区域 -->
      <view class="user-info-form">
        <!-- 头像选择 -->
        <view class="avatar-section">
          <text class="form-label">头像</text>
          <button class="avatar-btn" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
            <view class="avatar-preview-wrapper">
              <image wx:if="{{tempAvatarUrl}}" class="avatar-preview" src="{{tempAvatarUrl}}" mode="aspectFill"></image>
              <view wx:else class="avatar-placeholder">
                <text class="avatar-icon">👤</text>
              </view>
            </view>
            <text class="avatar-text">点击选择头像</text>
          </button>
        </view>
        
        <!-- 昵称输入 -->
        <view class="nickname-section">
          <text class="form-label">昵称</text>
          <input 
            class="nickname-input" 
            type="nickname" 
            placeholder="请输入昵称"
            value="{{tempNickName}}"
            bindinput="onNickNameInput"
            bindblur="onNickNameBlur"
          />
        </view>
      </view>
      
      <view class="login-actions">
        <button class="login-btn primary" hover-class="none" loading="{{isLoggingIn}}" bindtap="confirmLogin">确认登录</button>
      </view>
    </view>
  </view>

  <!-- 发布确认弹窗 -->
  <view class="login-mask" wx:if="{{showPublishDialog}}" bindtap="closePublishDialog">
    <view class="publish-dialog" catchtap="stopPropagation">
      <view class="publish-title">是否发布这条豆单？</view>
      <view class="publish-desc">
        发布后将展示在"发现"首页，其他用户可浏览。
      </view>
      <view class="publish-actions">
        <button class="publish-btn-cancel" hover-class="none" bindtap="closePublishDialog">取消</button>
        <button class="publish-btn-confirm" hover-class="none" loading="{{isPublishing}}" bindtap="publishRecord">确认发布</button>
      </view>
    </view>
  </view>

  <!-- 底部保存按钮 -->
  <view class="footer-bar">
    <button class="primary-btn" bindtap="saveRecord">
      {{isEdit ? '保存修改' : '保存记录'}}
    </button>
  </view>
</view>
